<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.js"></script>
  <script src="https://unpkg.com/cornerstone-tools@6.0.8/dist/cornerstoneTools.js"></script>
  <script
    src="https://unpkg.com/cornerstone-wado-image-loader@4.1.5/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
  <script src="https://unpkg.com/dicom-parser@1.8.13/dist/dicomParser.js"></script>
  <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
  <script src="https://unpkg.com/jquery@3.6.3/dist/jquery.js"></script>
  <style>
    html,
    body,
    #app {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      user-select: none;
    }

    .container {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      height: 60%;
      padding-top: 60px;
      font-family: "Avenir", Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .firstElement,
    .secondElement {
      flex-basis: 320px;
      min-width: 320px;
      min-height: 320px;
      flex-grow: 1;
      border: 2px solid rgb(0, 164, 217);
    }

    .operation {
      margin-top: 10px;
      padding: 0 5px;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="container">
      <div class="firstElement" oncontextmenu="return false"></div>
      <div class="secondElement" oncontextmenu="return false"></div>
    </div>
    <div class="operation">
      <label for="Overlay">覆盖层</label>
      <input type="radio" name="Overlay" value="true" checked />开启
      <input type="radio" name="Overlay" value="false" />关闭
    </div>
  </div>
</body>

<script>
  cornerstoneTools.init({
    touchEnabled: false,
    showSVGCursors: true,
  });
  cornerstoneTools.external.cornerstone = cornerstone;
  cornerstoneTools.external.cornerstoneMath = cornerstoneMath;

  cornerstoneWADOImageLoader.webWorkerManager.initialize({
    maxWebWorkers: navigator.hardwareConcurrency || 1,
    startWebWorkersOnDemand: true,
    taskConfiguration: {
      decodeTask: {
        initializeCodecsOnStartup: false,
      },
    },
    webWorkerTaskPaths: [
      "https://unpkg.com/cornerstone-wado-image-loader@4.1.5/dist/610.bundle.min.worker.js",
    ],
  });
  cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
  cornerstoneWADOImageLoader.external.dicomParser = dicomParser;

  const firstElement = $(".firstElement")[0];
  const secondElement = $(".secondElement")[0];
  const elements = [firstElement, secondElement];

  const firstImageIds = [
    "wadouri:http://182.92.128.9/file-system-online/dicom/CT/chest_lung/1/2.dcm",
  ];
  const secondImageIds = [];

  for (let i = 1; i < 55; i++) {
    secondImageIds.push(
      "wadouri:http://182.92.128.9/file-system-online/dicom/CT/chest_lung/2/" +
      i +
      ".dcm"
    );
  }

  const firstStack = {
    currentImageIdIndex: 0,
    imageIds: firstImageIds,
  };

  const secondStack = {
    currentImageIdIndex: 0,
    imageIds: secondImageIds,
  };

  const synchronizer = new cornerstoneTools.Synchronizer(
    "cornerstonenewimage",
    cornerstoneTools.updateImageSynchronizer
  );

  // image enable the dicomImage element and add canvas to it
  elements.forEach((element) => {
    cornerstone.enable(element);
  });

  const firstPromise = cornerstone
    .loadImage(firstImageIds[0])
    .then(function (image) {
      // display this image
      cornerstone.displayImage(firstElement, image);

      // set the stack as tool state
      cornerstoneTools.addStackStateManager(firstElement, [
        "stack",
        "referenceLines",
      ]);
      cornerstoneTools.addToolState(firstElement, "stack", firstStack);
    });

  const secondPromise = cornerstone
    .loadImage(secondImageIds[0])
    .then(function (image) {
      // display this image
      cornerstone.displayImage(secondElement, image);

      // set the stack as tool state
      cornerstoneTools.addStackStateManager(secondElement, [
        "stack",
        "referenceLines",
      ]);
      cornerstoneTools.addToolState(secondElement, "stack", secondStack);
    });

  function updateReferenceLines(activeElement) {
    elements.forEach((element) => {
      if (element === activeElement) {
        synchronizer.add(element);
      } else {
        synchronizer.remove(element);
      }
      cornerstone.updateImage(element);
    });
  }

  function addEvent() {
    elements.forEach((element) => {
      element.addEventListener("click", (e) => {
        updateReferenceLines(e.target.parentElement);
      });

      element.addEventListener("cornerstonetoolsstackscroll", (e) => {
        updateReferenceLines(e.target);
      });
    });

    $("input:radio").on("click", (e) => {
      const switchResult = $(e.currentTarget).val() === "true" ? true : false;

      if (switchResult) {
        cornerstoneTools.setToolEnabled(e.currentTarget.name);
      } else {
        cornerstoneTools.setToolDisabled(e.currentTarget.name);
      }
    });
  }

  Promise.all([firstPromise, secondPromise]).then(function () {
    synchronizer.add(secondElement);

    addEvent();

    const ReferenceLinesTool = cornerstoneTools.ReferenceLinesTool;

    cornerstoneTools.addTool(ReferenceLinesTool);
    cornerstoneTools.setToolEnabled("ReferenceLines", {
      synchronizationContext: synchronizer,
    });

    const OverlayTool = cornerstoneTools.OverlayTool;

    cornerstoneTools.addTool(OverlayTool);
    cornerstoneTools.setToolEnabled("Overlay");

    const StackScrollTool = cornerstoneTools.StackScrollTool;

    cornerstoneTools.addTool(StackScrollTool, {
      mouseButtonMask: 1,
    });
    cornerstoneTools.setToolActive("StackScroll", {
      mouseButtonMask: 1,
    });

    const StackScrollMouseWheelTool =
      cornerstoneTools.StackScrollMouseWheelTool;

    cornerstoneTools.addTool(StackScrollMouseWheelTool);
    cornerstoneTools.setToolActive("StackScrollMouseWheel", {
      mouseButtonMask: 4,
    });
  });
</script>

</html>